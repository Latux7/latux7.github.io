<!-- admin.html Grundgerüst -->
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <nav>
      <a href="index.html">Startseite</a>
      <a href="bestellen.html">Bestellen</a>
      <a href="bewerten.html">Bewerten</a>
    </nav>
    <h1>Admin Dashboard</h1>
    <div id="adminLogin">
      <form id="loginForm">
        <label>Passwort:<br><input type="password" id="adminPw" required></label>
        <input type="submit" value="Login">
      </form>
      <div id="loginError" style="display:none;color:#d32f2f;font-weight:bold;margin-top:12px;">Falsches Passwort!</div>
    </div>
    <div id="adminPanel" style="display:none;">
  <h2>Alle Bestellungen</h2>
  <div id="ordersList">Lade Bestellungen...</div>
    </div>
    <script src="firebase-config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script>
    // Einfaches statisches Passwort (z.B. "tortenadmin2025")
    const ADMIN_PW = "tortenadmin2025";
    // Firebase-Konfiguration aus externer Datei
    firebase.initializeApp(window.firebaseConfig);
    const db = firebase.firestore();

    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      if(document.getElementById('adminPw').value === ADMIN_PW) {
        document.getElementById('adminLogin').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        loadOrders();
      } else {
        document.getElementById('loginError').style.display = 'block';
      }
    });

    async function loadOrders() {
      const statusOptions = ['neu','angenommen','in Vorbereitung','abgelehnt','fertig'];
      let html = '';
      try {
        const snap = await db.collection('orders').orderBy('created','desc').get();
        const customerIds = Array.from(new Set(snap.docs.map(doc => doc.data().customerId)));
        const customers = {};
        if (customerIds.length > 0) {
          const custSnaps = await db.collection('customers').where(firebase.firestore.FieldPath.documentId(), 'in', customerIds).get();
          custSnaps.forEach(custDoc => { customers[custDoc.id] = custDoc.data(); });
        }
        if (snap.empty) {
          html = '<div style="margin:2em 0;">Keine Bestellungen vorhanden.</div>';
        } else {
          snap.forEach(doc => {
            const order = doc.data();
            const cust = customers[order.customerId] || {};
            html += `<div style="border:1px solid #dbeedb;border-radius:16px;padding:18px 16px;margin-bottom:24px;box-shadow:0 1px 8px #e6f4ea;">
              <div style="font-size:1.1em;font-weight:600;color:#92d050;">Bestellung vom ${order.created ? new Date(order.created).toLocaleString('de-DE') : '-'}</div>
              <div style="margin:8px 0 0 0;"><b>Kunde:</b> ${cust.name || '-'}<br>
                <b>E-Mail:</b> <a href="mailto:${cust.email||''}">${cust.email||''}</a><br>
                <b>Telefon:</b> ${cust.telefon||''}
              </div>
              <div style="margin:8px 0 0 0;"><b>Adresse:</b> ${cust.street||'-'}, ${cust.plz||''} ${cust.city||''}</div>
              <div style="margin:8px 0 0 0;"><b>Tortengröße:</b> ${order.details && order.details.groesse ? order.details.groesse : '-'}<br>
                <b>Extras:</b> ${(order.details && order.details.extras && order.details.extras.length) ? order.details.extras.join(', ') : 'keine'}<br>
                <b>Lieferung:</b> ${order.details && order.details.lieferung ? (order.details.lieferung === '' ? 'Abholung' : (order.details.lieferung === '20km' ? 'bis 20 km' : 'bis 40 km')) : 'Abholung'}
              </div>
              <div style="margin:8px 0 0 0;"><b>Status:</b> <select data-id="${doc.id}" class="statusSel" style="font-size:1em;padding:4px 10px;border-radius:8px;">
                ${statusOptions.map(opt => `<option value="${opt}"${order.status===opt?' selected':''}>${opt}</option>`).join('')}
              </select></div>
              <div style="margin:8px 0 0 0;"><b>Aktion:</b> <a href="mailto:${cust.email||''}">Mail an Kunde</a></div>
            </div>`;
          });
        }
        document.getElementById('ordersList').innerHTML = html;
        document.querySelectorAll('.statusSel').forEach(sel => {
          sel.addEventListener('change', async function() {
            try {
              await db.collection('orders').doc(this.dataset.id).update({status:this.value});
              alert('Status geändert für Bestellung ' + this.dataset.id + ' auf ' + this.value);
            } catch (err) {
              alert('Fehler beim Status-Update!');
            }
          });
        });
      } catch (err) {
        document.getElementById('ordersList').innerHTML = 'Fehler beim Laden der Bestellungen.';
      }
    }
    </script>
  </div>
</body>
</html>