<!-- admin.html Grundgerüst -->
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <nav>
      <a href="index.html">Startseite</a>
      <a href="bestellen.html">Bestellen</a>
      <a href="bewerten.html">Bewerten</a>
    </nav>
    <h1>Admin Dashboard</h1>
    <div id="adminLogin">
      <form id="loginForm">
        <label>Passwort:<br><input type="password" id="adminPw" required></label>
        <input type="submit" value="Login">
      </form>
      <div id="loginError" style="display:none;color:#d32f2f;font-weight:bold;margin-top:12px;">Falsches Passwort!</div>
    </div>
    <div id="adminPanel" style="display:none;">
      <h2>Bestellungen</h2>
      <div id="ordersList">Lade Bestellungen...</div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script>
    // Einfaches statisches Passwort (z.B. "tortenadmin2025")
    const ADMIN_PW = "tortenadmin2025";
    // Firebase-Konfiguration (ersetzen durch eigene Werte!)
    const firebaseConfig = {
      apiKey: "YOUR_FIREBASE_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      if(document.getElementById('adminPw').value === ADMIN_PW) {
        document.getElementById('adminLogin').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        loadOrders();
      } else {
        document.getElementById('loginError').style.display = 'block';
      }
    });

    async function loadOrders() {
      const statusOptions = ['neu','angenommen','in Vorbereitung','abgelehnt','fertig'];
      let html = '<table style="width:100%;border-collapse:collapse;margin-top:12px;">';
      html += '<tr><th>Kunde</th><th>Adresse</th><th>Telefon</th><th>Status</th><th>Aktion</th></tr>';
      try {
        const snap = await db.collection('orders').orderBy('created','desc').get();
        // Hole alle customerIds
        const customerIds = Array.from(new Set(snap.docs.map(doc => doc.data().customerId)));
        // Lade alle Kunden in einem Rutsch
        const customers = {};
        if (customerIds.length > 0) {
          const custSnaps = await db.collection('customers').where(firebase.firestore.FieldPath.documentId(), 'in', customerIds).get();
          custSnaps.forEach(custDoc => { customers[custDoc.id] = custDoc.data(); });
        }
        snap.forEach(doc => {
          const order = doc.data();
          const cust = customers[order.customerId] || {};
          html += `<tr>`;
          html += `<td>${cust.name || '-'}<br><a href="mailto:${cust.email||''}">${cust.email||''}</a></td>`;
          html += `<td>${cust.street||''}<br>${cust.plz||''} ${cust.city||''}</td>`;
          html += `<td>${cust.telefon||''}</td>`;
          html += `<td><select data-id="${doc.id}" class="statusSel">`;
          statusOptions.forEach(opt => {
            html += `<option value="${opt}"${order.status===opt?' selected':''}>${opt}</option>`;
          });
          html += `</select></td>`;
          html += `<td><a href="mailto:${cust.email||''}">Mail</a></td>`;
          html += `</tr>`;
        });
        html += '</table>';
        document.getElementById('ordersList').innerHTML = html;
        document.querySelectorAll('.statusSel').forEach(sel => {
          sel.addEventListener('change', async function() {
            try {
              await db.collection('orders').doc(this.dataset.id).update({status:this.value});
              alert('Status geändert für Bestellung ' + this.dataset.id + ' auf ' + this.value);
            } catch (err) {
              alert('Fehler beim Status-Update!');
            }
          });
        });
      } catch (err) {
        document.getElementById('ordersList').innerHTML = 'Fehler beim Laden der Bestellungen.';
      }
    }
    </script>
  </div>
</body>
</html>