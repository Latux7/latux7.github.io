<!-- admin.html Grundger√ºst -->
<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <header class="site-header">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <div class="title">Laura's Backstube</div>
            <div class="subtitle">Torten & Kuchen mit Liebe</div>
          </div>
        </div>
        <nav>
          <a href="index.html">Startseite</a>
          <a href="bestellen.html">Bestellen</a>
        </nav>
      </header>
      <section class="hero">
        <h1>Admin Dashboard</h1>
        <p>
          Verwalten Sie Bestellungen, aktualisieren Sie den Status und
          informieren Sie Kundinnen & Kunden.
        </p>
      </section>
      <div id="adminLogin">
        <form id="loginForm">
          <label
            >Passwort:<br /><input type="password" id="adminPw" required
          /></label>
          <input type="submit" value="Login" />
        </form>
        <div
          id="loginError"
          style="
            display: none;
            color: #d32f2f;
            font-weight: bold;
            margin-top: 12px;
          "
        >
          Falsches Passwort!
        </div>
      </div>
      <div id="adminPanel" style="display: none">
        <!-- Notification Container -->
        <div
          id="adminNotification"
          class="alert"
          style="display: none; margin-bottom: 20px"
        >
          <span id="notificationText"></span>
          <button
            onclick="hideNotification()"
            style="
              background: none;
              border: none;
              color: inherit;
              font-size: 1.2em;
              cursor: pointer;
              float: right;
              padding: 0;
              margin-left: 10px;
            "
          >
            &times;
          </button>
        </div>

        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h2 style="margin: 0">Bestellungen</h2>
          <button id="logoutBtn" class="btn-small btn-danger">Abmelden</button>
        </div>
        <div id="ordersList">Lade Bestellungen...</div>

        <div
          style="
            margin-top: 32px;
            border-top: 1px solid #eef4ee;
            padding-top: 20px;
          "
        >
          <h2 style="margin: 0 0 12px 0">Bewertungen</h2>
          <div id="reviewsList">Lade Bewertungen...</div>
        </div>
      </div>
      <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
      <script src="firebase-config.js"></script>
      <script src="price-config.js"></script>
      <script src="email-config.js"></script>
      <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
      <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
      <script>
        // Notification functions to replace alerts
        function showNotification(message, type = "success") {
          const notification = document.getElementById("adminNotification");
          const text = document.getElementById("notificationText");

          text.textContent = message;
          notification.className = `alert ${type}`;
          notification.style.display = "block";

          // Auto-hide after 5 seconds for success messages
          if (type === "success") {
            setTimeout(hideNotification, 5000);
          }
        }

        function hideNotification() {
          document.getElementById("adminNotification").style.display = "none";
        }

        // Einfaches statisches Passwort (z.B. "tortenadmin2025")
        const ADMIN_PW = "tortenadmin2025";

        // Firebase-Konfiguration aus externer Datei
        firebase.initializeApp(window.firebaseConfig);
        const db = firebase.firestore();

        // Bestellung l√∂schen (global verf√ºgbar)
        window.deleteOrder = async function (orderId) {
          if (
            !confirm(
              "Sind Sie sicher, dass Sie diese Bestellung l√∂schen m√∂chten? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden."
            )
          ) {
            return;
          }

          try {
            await db.collection("orders").doc(orderId).delete();
            showNotification("Bestellung erfolgreich gel√∂scht.", "success");
            loadOrders(); // Liste neu laden
          } catch (err) {
            console.error("Fehler beim L√∂schen:", err);
            showNotification("Fehler beim L√∂schen der Bestellung!", "error");
          }
        };

        // E-Mail Templates basierend auf Status
        function getEmailTemplate(status, customerName, orderDetails) {
          const templates = {
            angenommen: {
              subject: "Ihre Tortenbestellung wurde angenommen! üéÇ",
              html: `
                <h2>Liebe/r ${customerName},</h2>
                <p>vielen Dank f√ºr Ihre Bestellung bei Laura's Backstube!</p>
                <p><strong>Gute Nachricht:</strong> Ihre Tortenbestellung wurde angenommen und wird nun vorbereitet.</p>
                <p><strong>Bestelldetails:</strong><br>
                Tortengr√∂√üe: ${orderDetails.size}<br>
                Extras: ${orderDetails.extras}<br>
                Gesamtpreis: ${orderDetails.price}‚Ç¨</p>
                <p>Wir werden Sie informieren, sobald Ihre Torte fertig ist.</p>
                <p>Mit s√º√üen Gr√º√üen,<br>Laura's Backstube Team</p>
              `,
            },
            "in Vorbereitung": {
              subject: "Ihre Torte ist in Vorbereitung! üë©‚Äçüç≥",
              html: `
                <h2>Liebe/r ${customerName},</h2>
                <p>Ihre Torte wird gerade mit viel Liebe zubereitet!</p>
                <p>Unsere B√§ckerin arbeitet bereits an Ihrer individuellen Torte. Sie k√∂nnen sich schon auf das Ergebnis freuen!</p>
                <p><strong>Bestelldetails:</strong><br>
                Tortengr√∂√üe: ${orderDetails.size}<br>
                Extras: ${orderDetails.extras}<br>
                Gesamtpreis: ${orderDetails.price}‚Ç¨</p>
                <p>Wir melden uns, sobald Ihre Torte abholbereit ist.</p>
                <p>Mit s√º√üen Gr√º√üen,<br>Laura's Backstube Team</p>
              `,
            },
            fertig: {
              subject: "Ihre Torte ist fertig zur Abholung! üéâ",
              html: `
                <h2>Liebe/r ${customerName},</h2>
                <p><strong>Ihre Torte ist fertig!</strong></p>
                <p>Sie k√∂nnen Ihre wundersch√∂ne, frisch gebackene Torte jetzt abholen.</p>
                <p><strong>Bestelldetails:</strong><br>
                Tortengr√∂√üe: ${orderDetails.size}<br>
                Extras: ${orderDetails.extras}<br>
                Gesamtpreis: ${orderDetails.price}‚Ç¨</p>
                <p><strong>Abholung:</strong><br>
                ${window.emailConfig.company.name}<br>
                ${window.emailConfig.company.address}<br>
                ${window.emailConfig.company.postal}<br>
                √ñffnungszeiten: ${window.emailConfig.company.hours}</p>
                <p>Wir freuen uns auf Ihren Besuch!</p>
                <p>Mit s√º√üen Gr√º√üen,<br>Laura's Backstube Team</p>
              `,
            },
            abgelehnt: {
              subject: "Ihre Tortenbestellung - Leider m√ºssen wir absagen",
              html: `
                <h2>Liebe/r ${customerName},</h2>
                <p>vielen Dank f√ºr Ihr Interesse an Laura's Backstube.</p>
                <p>Leider m√ºssen wir Ihre Bestellung absagen. Dies kann verschiedene Gr√ºnde haben (Kapazit√§t, spezielle Anforderungen, etc.).</p>
                <p>Gerne k√∂nnen Sie uns telefonisch kontaktieren, um eine alternative L√∂sung zu finden.</p>
                <p>Wir entschuldigen uns f√ºr die Unannehmlichkeiten.</p>
                <p>Mit freundlichen Gr√º√üen,<br>Laura's Backstube Team</p>
              `,
            },
          };

          return templates[status] || null;
        }

        // E-Mail √ºber EmailJS senden (kostenlos, funktioniert vom Frontend)
        async function sendEmailToCustomer(
          customerEmail,
          customerName,
          status,
          orderDetails
        ) {
          try {
            const config = window.emailConfig;

            // EmailJS initialisieren
            emailjs.init(config.publicKey);

            // Bestimme Template und Parameter basierend auf Status
            let templateId, templateParams;

            if (status === "fertig") {
              // Verwende separates "fertig" Template
              templateId = config.templates.order_ready;

              // Bestimme Liefermethode (Standard = Abholung)
              const deliveryType = orderDetails.delivery || "abholung";
              const deliveryMessage =
                config.deliveryMessages[deliveryType] ||
                config.deliveryMessages.abholung;

              // Erstelle Review-Link mit orderId und customerId
              const reviewLink = `${
                window.location.origin
              }/bewerten.html?orderId=${orderDetails.orderId}&customerId=${
                orderDetails.customerId || ""
              }`;

              templateParams = {
                to: customerEmail, // Alternative 1
                to_email: customerEmail, // Standard
                user_email: customerEmail, // Alternative 2
                email: customerEmail, // Alternative 3
                to_name: customerName,
                customer_name: customerName,
                order_items: `${orderDetails.size} mit ${orderDetails.extras}`,
                total_price: orderDetails.price,
                company_email: config.company.email,
                delivery_message: deliveryMessage,
                review_link: reviewLink,
                wunschtermin: orderDetails.wunschtermin || "Nicht angegeben",
              };
            } else {
              // Verwende universelles Status-Template
              templateId = config.templates.order_status;
              const statusInfo = config.statusData[status];

              if (!statusInfo) {
                showNotification(
                  'Status "' + status + '" nicht konfiguriert!',
                  "error"
                );
                return;
              }

              templateParams = {
                to: customerEmail, // Alternative 1
                to_email: customerEmail, // Standard
                user_email: customerEmail, // Alternative 2
                email: customerEmail, // Alternative 3
                to_name: customerName,
                customer_name: customerName,
                order_items: `${orderDetails.size} mit ${orderDetails.extras}`,
                total_price: orderDetails.price,
                company_email: config.company.email,
                header_color: statusInfo.header_color,
                status_title: statusInfo.title,
                status_message: statusInfo.message,
                delivery_message: "", // Leer bei allen Status au√üer "fertig"
                footer_message: statusInfo.footer_message,
                wunschtermin: orderDetails.wunschtermin || "Nicht angegeben",
              };
            }

            console.log(
              "Sende E-Mail mit Template:",
              templateId,
              templateParams
            );

            // Alternative Sendemethode f√ºr bessere Kompatibilit√§t
            const response = await emailjs.send(
              config.serviceId,
              templateId,
              templateParams,
              {
                publicKey: config.publicKey,
                // Zus√§tzliche Optionen f√ºr Empf√§nger
                to_email: customerEmail,
                to_name: customerName,
              }
            );

            console.log("E-Mail erfolgreich gesendet:", response);
            showNotification(
              "E-Mail erfolgreich an " + customerEmail + " gesendet!",
              "success"
            );
          } catch (error) {
            console.error("E-Mail Versand Fehler:", error);
            showNotification(
              "Fehler beim E-Mail-Versand: " + (error.text || error.message),
              "error"
            );
          }
        }

        // Status-E-Mail senden (global verf√ºgbar)
        window.sendStatusEmail = async function (
          orderId,
          customerEmail,
          customerName,
          status,
          size,
          extras,
          price
        ) {
          if (!customerEmail) {
            showNotification(
              "Keine E-Mail-Adresse f√ºr diesen Kunden verf√ºgbar.",
              "error"
            );
            return;
          }

          // Pr√ºfe EmailJS-Konfiguration
          if (
            !window.emailConfig.serviceId ||
            !window.emailConfig.publicKey ||
            window.emailConfig.publicKey === "YOUR_EMAILJS_PUBLIC_KEY"
          ) {
            showNotification(
              "EmailJS nicht konfiguriert. Bitte Public Key in email-config.js eintragen.",
              "error"
            );
            return;
          }

          // Hole Bestellungsdetails falls zus√§tzliche Infos ben√∂tigt werden
          try {
            const orderDoc = await db.collection("orders").doc(orderId).get();
            const orderData = orderDoc.data();

            const orderDetails = {
              orderId: orderId, // F√ºr Review-Link
              size: size || "Unbekannt",
              extras: extras || "keine",
              price: price || "0",
              delivery: orderData?.lieferung ? "lieferung" : "abholung", // Bestimme Lieferart
              customerId: orderData?.customerId, // F√ºr Review-Link
              wunschtermin: orderData?.wunschtermin
                ? `${new Date(orderData.wunschtermin.datum).toLocaleDateString(
                    "de-DE"
                  )}${
                    orderData.wunschtermin.uhrzeit
                      ? ` um ${orderData.wunschtermin.uhrzeit}`
                      : ""
                  }`
                : "Nicht angegeben",
            };

            await sendEmailToCustomer(
              customerEmail,
              customerName,
              status,
              orderDetails
            );
          } catch (error) {
            console.error("Fehler beim Laden der Bestelldetails:", error);
            // Fallback mit verf√ºgbaren Daten
            const orderDetails = {
              orderId: orderId, // F√ºr Review-Link
              size: size || "Unbekannt",
              extras: extras || "keine",
              price: price || "0",
              delivery: "abholung", // Standard
              wunschtermin: "Nicht angegeben",
            };

            await sendEmailToCustomer(
              customerEmail,
              customerName,
              status,
              orderDetails
            );
          }
        };

        // Pr√ºfe beim Laden, ob bereits angemeldet
        function checkLoginStatus() {
          if (localStorage.getItem("adminLoggedIn") === "true") {
            document.getElementById("adminLogin").style.display = "none";
            document.getElementById("adminPanel").style.display = "block";
            loadOrders();
            loadReviews();
          }
        }

        // Login-Handler
        document
          .getElementById("loginForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            if (document.getElementById("adminPw").value === ADMIN_PW) {
              localStorage.setItem("adminLoggedIn", "true");
              document.getElementById("adminLogin").style.display = "none";
              document.getElementById("adminPanel").style.display = "block";
              loadOrders();
              loadReviews();
            } else {
              document.getElementById("loginError").style.display = "block";
            }
          });

        // Logout-Handler
        function logout() {
          localStorage.removeItem("adminLoggedIn");
          document.getElementById("adminLogin").style.display = "block";
          document.getElementById("adminPanel").style.display = "none";
          document.getElementById("adminPw").value = "";
          document.getElementById("loginError").style.display = "none";
          hideNotification(); // Hide any notifications when logging out
        }

        // Beim Laden der Seite pr√ºfen
        window.addEventListener("DOMContentLoaded", function () {
          checkLoginStatus();

          // Logout-Button Event-Listener hinzuf√ºgen
          document
            .getElementById("logoutBtn")
            .addEventListener("click", logout);
        });

        // Hilfsfunktion: Bestellungshistorie f√ºr Kunden ermitteln (nach E-Mail gruppiert)
        async function getCustomerOrderHistory() {
          const orderHistory = {};
          const customerEmailMap = {}; // customerId -> email mapping

          try {
            // Zuerst alle Kunden laden um E-Mail-Adressen zu bekommen
            const customersSnap = await db.collection("customers").get();
            customersSnap.forEach((doc) => {
              const customer = doc.data();
              if (customer.email) {
                customerEmailMap[doc.id] = customer.email.toLowerCase();
              }
            });

            // Alle Bestellungen laden, sortiert nach Erstellungsdatum
            const allOrdersSnap = await db
              .collection("orders")
              .orderBy("created", "asc")
              .get();

            allOrdersSnap.forEach((doc, index) => {
              const order = doc.data();
              const customerId = order.customerId;
              const customerEmail = customerEmailMap[customerId];

              if (!customerEmail) {
                console.warn(
                  `Keine E-Mail f√ºr customerId ${customerId} gefunden`
                );
                return;
              }

              // Gruppierung nach E-Mail-Adresse statt customerId
              if (!orderHistory[customerEmail]) {
                orderHistory[customerEmail] = {
                  totalOrders: 0,
                  orderNumbers: {},
                  customerIds: new Set(), // Sammle alle customerIds f√ºr diese E-Mail
                };
              }

              orderHistory[customerEmail].totalOrders++;
              orderHistory[customerEmail].orderNumbers[doc.id] =
                orderHistory[customerEmail].totalOrders;
              orderHistory[customerEmail].customerIds.add(customerId);
            });
          } catch (error) {
            console.error("Fehler beim Laden der Bestellungshistorie:", error);
          }

          return orderHistory;
        }

        async function loadOrders() {
          const statusOptions = [
            "neu",
            "angenommen",
            "in Vorbereitung",
            "abgelehnt",
            "fertig",
          ];
          let html = "";
          try {
            // Bestellungshistorie laden
            const orderHistory = await getCustomerOrderHistory();

            const snap = await db
              .collection("orders")
              .orderBy("created", "desc")
              .get();
            const customerIds = Array.from(
              new Set(snap.docs.map((doc) => doc.data().customerId))
            );
            const customers = {};
            if (customerIds.length > 0) {
              const custSnaps = await db
                .collection("customers")
                .where(
                  firebase.firestore.FieldPath.documentId(),
                  "in",
                  customerIds
                )
                .get();
              custSnaps.forEach((custDoc) => {
                customers[custDoc.id] = custDoc.data();
              });
            }
            if (snap.empty) {
              html =
                '<div style="margin:2em 0;">Keine Bestellungen vorhanden.</div>';
            } else {
              // Gruppiere Bestellungen nach Status (fertig wird ausgeblendet)
              const grouped = {
                neu: [],
                angenommen: [],
                "in Vorbereitung": [],
                abgelehnt: [],
                fertig: [],
              };
              snap.forEach((doc) => {
                const order = doc.data();
                if (grouped[order.status])
                  grouped[order.status].push({ doc, order });
              });
              // Accordion UI
              html += `<div style="margin-bottom:18px;">`;
              // NEU immer offen
              html += `<details open style='margin-bottom:12px;'><summary style="font-size:1.1em;font-weight:600;color:#d32f2f;cursor:pointer;">Neue Bestellungen (${grouped.neu.length})</summary>`;
              if (grouped.neu.length === 0) {
                html +=
                  '<div style="margin:1em 0 1em 1em;">Keine neuen Bestellungen.</div>';
              } else {
                grouped.neu.forEach(({ doc, order }) => {
                  const cust = customers[order.customerId] || {};
                  const customerEmail = cust.email
                    ? cust.email.toLowerCase()
                    : null;
                  const orderInfo =
                    customerEmail && orderHistory[customerEmail]
                      ? orderHistory[customerEmail]
                      : {
                          totalOrders: 1,
                          orderNumbers: { [doc.id]: 1 },
                        };
                  const orderNumber = orderInfo.orderNumbers[doc.id] || 1;
                  const isFirstOrder = orderNumber === 1;
                  html += renderOrder(
                    doc,
                    order,
                    cust,
                    statusOptions,
                    orderInfo.totalOrders,
                    orderNumber,
                    isFirstOrder
                  );
                });
              }
              html += `</details>`;
              // Andere Status (zugeklappt)
              const otherStatus = [
                "angenommen",
                "in Vorbereitung",
                "abgelehnt",
                "fertig",
              ];
              otherStatus.forEach((st) => {
                html += `<details style='margin-bottom:12px;'><summary style="font-size:1.1em;font-weight:600;color:#92d050;cursor:pointer;">${
                  st.charAt(0).toUpperCase() + st.slice(1)
                } (${grouped[st].length})</summary>`;
                if (grouped[st].length === 0) {
                  html +=
                    '<div style="margin:1em 0 1em 1em;">Keine Bestellungen.</div>';
                } else {
                  grouped[st].forEach(({ doc, order }) => {
                    const cust = customers[order.customerId] || {};
                    const customerEmail = cust.email
                      ? cust.email.toLowerCase()
                      : null;
                    const orderInfo =
                      customerEmail && orderHistory[customerEmail]
                        ? orderHistory[customerEmail]
                        : {
                            totalOrders: 1,
                            orderNumbers: { [doc.id]: 1 },
                          };
                    const orderNumber = orderInfo.orderNumbers[doc.id] || 1;
                    const isFirstOrder = orderNumber === 1;
                    html += renderOrder(
                      doc,
                      order,
                      cust,
                      statusOptions,
                      orderInfo.totalOrders,
                      orderNumber,
                      isFirstOrder
                    );
                  });
                }
                html += `</details>`;
              });
              html += `</div>`;
            }
            document.getElementById("ordersList").innerHTML = html;
            document.querySelectorAll(".statusSel").forEach((sel) => {
              sel.addEventListener("change", async function () {
                try {
                  await db
                    .collection("orders")
                    .doc(this.dataset.id)
                    .update({ status: this.value });
                  showNotification(
                    "Status ge√§ndert f√ºr Bestellung " +
                      this.dataset.id +
                      " auf " +
                      this.value,
                    "success"
                  );
                  loadOrders(); // Liste neu laden
                } catch (err) {
                  showNotification("Fehler beim Status-Update!", "error");
                }
              });
            });
          } catch (err) {
            document.getElementById("ordersList").innerHTML =
              "Fehler beim Laden der Bestellungen.";
          }
        }

        // Hilfsfunktion f√ºr Bestell-HTML
        function renderOrder(
          doc,
          order,
          cust,
          statusOptions,
          totalOrders,
          orderNumber,
          isFirstOrder
        ) {
          // Bestellungshistorie-Badge erstellen
          let orderHistoryBadge = "";
          if (orderNumber === 1) {
            // Erste Bestellung dieses Kunden - sehr deutlich hervorheben
            orderHistoryBadge = `
              <div style="
                display: inline-block; 
                background: linear-gradient(135deg, #ff6b6b, #ee5a24); 
                color: white; 
                padding: 8px 16px; 
                border-radius: 20px; 
                font-weight: bold; 
                font-size: 0.95em; 
                box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
                animation: pulse 2s infinite;
                margin-left: 12px;
                border: 2px solid #fff;
              ">
                üéâ ERSTE BESTELLUNG JEMALS! üéâ
              </div>
              <style>
                @keyframes pulse {
                  0% { transform: scale(1); }
                  50% { transform: scale(1.05); }
                  100% { transform: scale(1); }
                }
              </style>
            `;
          } else {
            // Wiederholungsbestellung
            orderHistoryBadge = `
              <div style="
                display: inline-block; 
                background: #2196F3; 
                color: white; 
                padding: 6px 12px; 
                border-radius: 15px; 
                font-weight: bold; 
                font-size: 0.9em; 
                margin-left: 12px;
              ">
                üìã Bestellung #${orderNumber} von ${totalOrders}
              </div>
            `;
          }

          return `<div style="border:1px solid #dbeedb;border-radius:16px;padding:18px 16px;margin-bottom:24px;box-shadow:0 1px 8px #e6f4ea;">
        <div style="font-size:1.1em;font-weight:600;color:#92d050;display:flex;align-items:center;flex-wrap:wrap;">
          <span>Bestellung vom ${
            order.created
              ? new Date(order.created).toLocaleString("de-DE")
              : "-"
          }</span>
          ${orderHistoryBadge}
        </div>
        <div style="margin:8px 0 0 0;"><b>Kunde:</b> ${cust.name || "-"}<br>
          <b>E-Mail:</b> <a href="mailto:${cust.email || ""}">${
            cust.email || ""
          }</a><br>
          <b>Telefon:</b> ${cust.telefon || ""}
        </div>
        <div style="margin:8px 0 0 0;"><b>Adresse:</b> ${
          order.adresse
            ? `${order.adresse.street || "-"}, ${order.adresse.plz || ""} ${
                order.adresse.city || ""
              }`
            : cust.street
            ? `${cust.street || "-"}, ${cust.plz || ""} ${cust.city || ""}`
            : "Keine Adresse (Abholung)"
        }</div>
        <div style="margin:8px 0 0 0;">
          <b>Tortengr√∂√üe:</b> ${
            order.details && order.details.durchmesserCm
              ? `${order.details.durchmesserCm} cm`
              : order.details && order.details.groesse
              ? order.details.groesse
              : "-"
          }<br>
          <b>Extras:</b> ${
            order.details && order.details.extras && order.details.extras.length
              ? order.details.extras.join(", ")
              : "keine"
          }<br>
          <b>Lieferung:</b> ${
            order.details && order.details.lieferung
              ? order.details.lieferung === ""
                ? "Abholung"
                : order.details.lieferung === "20km"
                ? "bis 20 km"
                : "bis 40 km"
              : "Abholung"
          }<br>
          <b>Gew√ºnschter Termin:</b> ${
            order.wunschtermin && order.wunschtermin.datum
              ? `${new Date(order.wunschtermin.datum).toLocaleDateString(
                  "de-DE"
                )}${
                  order.wunschtermin.uhrzeit
                    ? ` um ${order.wunschtermin.uhrzeit}`
                    : ""
                }`
              : "Nicht angegeben"
          }
        </div>
        <div style="margin:8px 0 0 0;"><b>Gesamtwert:</b> <span style="font-weight:600;color:#d32f2f;">${
          order.gesamtpreis || "nicht berechnet"
        } ‚Ç¨</span></div>
        <div style="margin:8px 0 0 0;"><b>Status:</b> <select data-id="${
          doc.id
        }" class="statusSel" style="font-size:1em;padding:4px 10px;border-radius:8px;">
          ${statusOptions
            .map(
              (opt) =>
                `<option value="${opt}"${
                  order.status === opt ? " selected" : ""
                }>${opt}</option>`
            )
            .join("")}
        </select></div>
        <div style="margin:8px 0 0 0;"><b>Aktion:</b> 
          <button onclick="sendStatusEmail('${doc.id}', '${
            cust.email || ""
          }', '${cust.name || ""}', '${order.status}', '${
            order.details && order.details.durchmesserCm
              ? order.details.durchmesserCm + " cm"
              : order.details && order.details.groesse
              ? order.details.groesse
              : "-"
          }', '${
            order.details && order.details.extras && order.details.extras.length
              ? order.details.extras.join(", ")
              : "keine"
          }', '${order.gesamtpreis || "nicht berechnet"}')" 
                  class="btn-small" style="background:#4CAF50;color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.9em;margin-right:8px;">Status-Mail senden</button>
          <button onclick="deleteOrder('${
            doc.id
          }')" class="btn-small btn-danger" style="border-radius:6px;">L√∂schen</button>
        </div>
      </div>`;
        }

        // Bewertung l√∂schen (global verf√ºgbar)
        window.deleteReview = async function (reviewId) {
          if (!confirm("Diese Bewertung wirklich l√∂schen?")) return;
          try {
            await db.collection("reviews").doc(reviewId).delete();
            showNotification("Bewertung gel√∂scht.", "success");
            loadReviews();
          } catch (e) {
            console.error(e);
            showNotification("Fehler beim L√∂schen der Bewertung.", "error");
          }
        };

        // Bewertungen laden und rendern
        async function loadReviews() {
          try {
            const snap = await db
              .collection("reviews")
              .orderBy("created", "desc")
              .get();
            if (snap.empty) {
              document.getElementById("reviewsList").innerHTML =
                '<div style="margin:1em 0;">Keine Bewertungen vorhanden.</div>';
              return;
            }

            // Bestell-Infos zuordnen (optional)
            const orderIds = Array.from(
              new Set(snap.docs.map((d) => d.data().orderId).filter(Boolean))
            );
            const ordersMap = {};
            if (orderIds.length) {
              const orderDocs = await Promise.all(
                orderIds.map((id) =>
                  db
                    .collection("orders")
                    .doc(id)
                    .get()
                    .catch(() => null)
                )
              );
              orderDocs.forEach((od) => {
                if (od && od.exists) ordersMap[od.id] = od.data();
              });
            }
            // Kunden optional nachziehen
            const customerIds = Array.from(
              new Set(
                Object.values(ordersMap)
                  .map((o) => o.customerId)
                  .filter(Boolean)
              )
            );
            const customersMap = {};
            if (customerIds.length) {
              const custDocs = await db
                .collection("customers")
                .where(
                  firebase.firestore.FieldPath.documentId(),
                  "in",
                  customerIds.slice(0, 10)
                )
                .get()
                .catch(() => null);
              if (custDocs)
                custDocs.forEach((cd) => (customersMap[cd.id] = cd.data()));
              // Hinweis: Mehr als 10 Kunden sind selten hier; f√ºr mehr k√∂nnte man paginieren.
            }

            let html = "";
            snap.forEach((doc) => {
              const r = doc.data();
              const order = r.orderId ? ordersMap[r.orderId] : null;
              const customer =
                order && order.customerId
                  ? customersMap[order.customerId]
                  : null;
              html += renderReview(doc, r, order, customer);
            });
            document.getElementById("reviewsList").innerHTML = html;
          } catch (err) {
            console.error(err);
            document.getElementById("reviewsList").innerHTML =
              "Fehler beim Laden der Bewertungen.";
          }
        }

        function renderReview(doc, review, order, customer) {
          const label = (v) =>
            ({
              1: "Unzufrieden",
              2: "Zufriedenstellend",
              3: "Gut",
              4: "Sehr gut",
              5: "Exzellent",
            }[Number(v)] || "-");

          const when = review.created
            ? new Date(review.created).toLocaleString("de-DE")
            : "-";
          const nps = review.empfehlung ? Number(review.empfehlung) : null;
          const custName = review.customerName || customer?.name || "-";
          const custEmail = customer?.email || "";
          const orderRef = review.orderId
            ? `#${review.orderId.slice(0, 6)}`
            : "‚Äî";

          return `<div style="border:1px solid #dbeedb;border-radius:16px;padding:14px 16px;margin:14px 0;box-shadow:0 1px 8px #e6f4ea;">
            <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
              <div style="font-weight:600;color:#2f855a;">Bewertung vom ${when}</div>
              <div>
                <button onclick="deleteReview('${
                  doc.id
                }')" class="btn-small btn-danger" style="border-radius:6px;">L√∂schen</button>
              </div>
            </div>
            <div style="margin-top:6px;color:#374151;">
              <b>Kunde:</b> ${custName} ${
            custEmail
              ? `&lt;<a href=\"mailto:${custEmail}\">${custEmail}</a>&gt;`
              : ""
          }
              &nbsp;‚Ä¢&nbsp; <b>Bestellung:</b> ${orderRef}
            </div>
            <div style="display:grid;grid-template-columns: repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:10px;">
              <div><b>Geschmack:</b> ${label(review.geschmack)}</div>
              <div><b>Aussehen:</b> ${label(review.aussehen)}</div>
              <div><b>Service:</b> ${label(review.service)}</div>
              <div><b>Gesamteindruck:</b> ${label(review.gesamt)}</div>
              <div><b>Weiterempfehlung:</b> ${nps ?? "-"}/10</div>
            </div>
            ${
              review.text
                ? `<div style=\"margin-top:10px;white-space:pre-wrap;\"><b>Kommentar:</b> ${escapeHtml(
                    review.text
                  )}</div>`
                : ""
            }
          </div>`;
        }

        function escapeHtml(s) {
          if (!s) return "";
          return s
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }
      </script>
    </div>
  </body>
</html>
