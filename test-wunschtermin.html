<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wunschtermin-Limit Test - Laura's Backstube</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="js/website-protection.js"></script>
</head>
<body>
    <div class="container">
        <header class="site-header">
            <div class="brand">
                <div class="logo"></div>
                <div>
                    <div class="title">Laura's Backstube</div>
                    <div class="subtitle">Wunschtermin-Limit Test</div>
                </div>
            </div>
        </header>

        <section class="hero">
            <h1>üß™ Wunschtermin-Limit Test</h1>
            <p>Diese Seite testet das neue wunschtermin-basierte Limitierungssystem</p>
        </section>

        <div style="background: white; padding: 20px; border-radius: 12px; margin: 20px 0;">
            <h3>üéØ Test-Funktionen</h3>
            
            <div style="margin: 15px 0;">
                <label for="testDate">Datum zum Testen:</label>
                <input type="date" id="testDate" style="margin-left: 10px;">
                <button onclick="testDateLimit()" style="margin-left: 10px;">Limit pr√ºfen</button>
            </div>

            <div style="margin: 15px 0;">
                <button onclick="createTestOrder()">Test-Bestellung erstellen</button>
                <button onclick="showOrderCounts()" style="margin-left: 10px;">Alle Wunschtermine anzeigen</button>
                <button onclick="clearTestOrders()" style="margin-left: 10px; background: #f44336;">Test-Daten l√∂schen</button>
            </div>

            <div id="testResults" style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px; min-height: 50px;">
                <p><em>Test-Ergebnisse werden hier angezeigt...</em></p>
            </div>
        </div>

        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <h4>üìã So funktioniert das neue System:</h4>
            <ul style="margin: 10px 0; padding-left: 20px;">
                <li><strong>Wunschtermin-basiert:</strong> Limitierung erfolgt nach dem gew√§hlten Wunschtermin, nicht nach Bestelldatum</li>
                <li><strong>5 Bestellungen/Tag:</strong> Maximal 5 Bestellungen k√∂nnen denselben Wunschtermin haben</li>
                <li><strong>Echtzeitpr√ºfung:</strong> Beim Ausw√§hlen eines Datums wird sofort die Verf√ºgbarkeit gepr√ºft</li>
                <li><strong>Visuelles Feedback:</strong> Datum-Eingabefeld wird entsprechend eingef√§rbt (rot=ausgebucht, orange=wenig Pl√§tze, gr√ºn=verf√ºgbar)</li>
                <li><strong>Kalender-Integration:</strong> √ñffentlicher Kalender zeigt Kapazit√§t basierend auf Wunschterminen</li>
            </ul>
        </div>
    </div>

    <!-- Firebase Bibliotheken -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="config/firebase.js"></script>
    <script src="js/common.js"></script>
    <script src="js/order-limits.js"></script>

    <script>
        let db = null;

        function logResult(message, type = "info") {
            const resultsDiv = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === "error" ? "#f44336" : type === "success" ? "#4caf50" : "#333";
            
            resultsDiv.innerHTML += `<div style="color: ${color}; margin: 5px 0;">[${timestamp}] ${message}</div>`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        async function initTest() {
            try {
                db = initializeFirebaseApp();
                if (db) {
                    logResult("‚úÖ Firebase erfolgreich initialisiert", "success");
                    
                    // Heutiges Datum als Standard setzen
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('testDate').value = today;
                } else {
                    logResult("‚ùå Firebase-Initialisierung fehlgeschlagen", "error");
                }
            } catch (error) {
                logResult(`‚ùå Fehler beim Initialisieren: ${error.message}`, "error");
            }
        }

        async function testDateLimit() {
            const dateInput = document.getElementById('testDate');
            const testDate = dateInput.value;
            
            if (!testDate) {
                logResult("‚ùå Bitte w√§hlen Sie ein Datum aus", "error");
                return;
            }

            logResult(`üîç Pr√ºfe Limit f√ºr Wunschtermin: ${testDate}`);
            
            try {
                const status = await window.orderLimitManager.canAcceptOrder(testDate);
                
                if (status.canAccept) {
                    logResult(`‚úÖ ${testDate} ist verf√ºgbar (${status.currentCount}/${status.limit} belegt, ${status.remaining} frei)`, "success");
                } else {
                    logResult(`‚ùå ${testDate} ist ausgebucht (${status.currentCount}/${status.limit} belegt)`, "error");
                }
            } catch (error) {
                logResult(`‚ùå Fehler bei Limitpr√ºfung: ${error.message}`, "error");
            }
        }

        async function createTestOrder() {
            const dateInput = document.getElementById('testDate');
            const testDate = dateInput.value;
            
            if (!testDate) {
                logResult("‚ùå Bitte w√§hlen Sie ein Datum aus", "error");
                return;
            }

            try {
                const orderId = `test_${Date.now()}`;
                const testOrder = {
                    created: new Date().toISOString(),
                    wunschtermin: {
                        datum: testDate,
                        uhrzeit: "15:00"
                    },
                    status: "neu",
                    gesamtpreis: 55,
                    isTestOrder: true // Markierung f√ºr einfaches L√∂schen
                };

                await db.collection('orders').doc(orderId).set(testOrder);
                logResult(`‚úÖ Test-Bestellung f√ºr ${testDate} erstellt (ID: ${orderId})`, "success");
                
                // Limit erneut pr√ºfen
                setTimeout(() => testDateLimit(), 1000);
                
            } catch (error) {
                logResult(`‚ùå Fehler beim Erstellen der Test-Bestellung: ${error.message}`, "error");
            }
        }

        async function showOrderCounts() {
            try {
                logResult("üìä Lade alle Wunschtermine...");
                
                const ordersSnapshot = await db.collection('orders')
                    .where('isTestOrder', '==', true)
                    .get();

                const dateCount = {};
                ordersSnapshot.forEach(doc => {
                    const order = doc.data();
                    const datum = order.wunschtermin?.datum;
                    if (datum) {
                        dateCount[datum] = (dateCount[datum] || 0) + 1;
                    }
                });

                if (Object.keys(dateCount).length === 0) {
                    logResult("‚ÑπÔ∏è Keine Test-Bestellungen gefunden");
                } else {
                    logResult("üìä Test-Bestellungen nach Wunschtermin:");
                    Object.entries(dateCount)
                        .sort()
                        .forEach(([datum, count]) => {
                            const status = count >= 5 ? "üî¥ VOLL" : count >= 3 ? "üü° WENIG" : "üü¢ FREI";
                            logResult(`   ${datum}: ${count}/5 Bestellungen ${status}`);
                        });
                }
            } catch (error) {
                logResult(`‚ùå Fehler beim Laden der √úbersicht: ${error.message}`, "error");
            }
        }

        async function clearTestOrders() {
            try {
                const confirmed = confirm("Alle Test-Bestellungen l√∂schen?");
                if (!confirmed) return;

                logResult("üóëÔ∏è L√∂sche alle Test-Bestellungen...");
                
                const ordersSnapshot = await db.collection('orders')
                    .where('isTestOrder', '==', true)
                    .get();

                const batch = db.batch();
                ordersSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                logResult(`‚úÖ ${ordersSnapshot.size} Test-Bestellungen gel√∂scht`, "success");
                
            } catch (error) {
                logResult(`‚ùå Fehler beim L√∂schen: ${error.message}`, "error");
            }
        }

        // Auto-Initialisierung
        document.addEventListener('DOMContentLoaded', initTest);
    </script>
</body>
</html>