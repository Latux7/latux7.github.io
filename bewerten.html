<!-- bewerten.html Grundgerüst -->
<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Torte bewerten</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <!-- Script/Handwriting fonts for review page heading and NPS numbers -->
    <link
      href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600;700&family=Kalam:wght@300;400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/style.css" />
    <!-- Website Passwort-Schutz (muss als erstes geladen werden) -->
    <script src="js/website-protection.js"></script>
  </head>
  <body>
    <div class="container">
      <header class="site-header">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <div class="title">Laura's Backstube</div>
            <div class="subtitle">Torten & Kuchen mit Liebe</div>
          </div>
        </div>
        <nav>
          <a href="index.html">Startseite</a>
          <a href="bestellen.html">Bestellen</a>
        </nav>
      </header>
      <section class="review-intro">
        <h1 class="review-title">Feedback zur Torte & Service</h1>
        <p class="review-note">
          Vielen Dank, dass Sie sich für eine Torte von mir entschieden haben!
          Ihr Feedback ist mir sehr wichtig – so erfahre ich, was Ihnen gefallen
          hat und wo ich mich noch verbessern kann.
        </p>
      </section>
      <form id="reviewForm" class="review-form">
        <fieldset>
          <legend>Wie hat Ihnen die Torte geschmeckt?</legend>
          <div class="heart-group" role="radiogroup" aria-label="Geschmack">
            <label class="heart-option">
              <input type="radio" name="geschmack" value="1" required />
              <span class="heart-icon">♡</span>
              <span class="heart-label">Unzufrieden</span>
            </label>
            <label class="heart-option">
              <input type="radio" name="geschmack" value="2" />
              <span class="heart-icon">♡</span>
              <span class="heart-label">Mittel</span>
            </label>
            <label class="heart-option">
              <input type="radio" name="geschmack" value="3" />
              <span class="heart-icon">♡</span>
              <span class="heart-label">Gut</span>
            </label>
            <label class="heart-option">
              <input type="radio" name="geschmack" value="4" />
              <span class="heart-icon">♡</span>
              <span class="heart-label">Sehr gut</span>
            </label>
            <label class="heart-option">
              <input type="radio" name="geschmack" value="5" />
              <span class="heart-icon">♡</span>
              <span class="heart-label">Exzellent</span>
            </label>
          </div>
        </fieldset>
        <fieldset>
          <legend>
            Wie fanden Sie das Aussehen / die Dekoration der Torte?
          </legend>
          <div class="heart-group" role="radiogroup" aria-label="Aussehen">
            <label class="heart-option">
              <input type="radio" name="aussehen" value="1" required />
              <span class="heart-icon">♡</span>
              <span class="heart-label">Unzufrieden</span>
            </label>
            <label class="heart-option">
              <input type="radio" name="aussehen" value="2" />
              <span class="heart-icon">♡</span>
              <span class="heart-label">Mittel</span>
            </label>
            <label class="heart-option">
              <input type="radio" name="aussehen" value="3" />
              <span class="heart-icon">♡</span>
              <span class="heart-label">Gut</span>
            </label>
            <label class="heart-option">
              <input type="radio" name="aussehen" value="4" />
              <span class="heart-icon">♡</span>
              <span class="heart-label">Sehr gut</span>
            </label>
            <label class="heart-option">
              <input type="radio" name="aussehen" value="5" />
              <span class="heart-icon">♡</span>
              <span class="heart-label">Exzellent</span>
            </label>
          </div>
        </fieldset>
        <fieldset>
          <legend>
            Wie zufrieden waren Sie mit meinem Service (Kommunikation,
            Abwicklung, ggf. Lieferung)?
          </legend>
          <div class="heart-group" role="radiogroup" aria-label="Service">
            <label class="heart-option">
              <input type="radio" name="service" value="1" required />
              <span class="heart-icon">♡</span>
              <span class="heart-label">Unzufrieden</span>
            </label>
            <label class="heart-option">
              <input type="radio" name="service" value="2" />
              <span class="heart-icon">♡</span>
              <span class="heart-label">Mittel</span>
            </label>
            <label class="heart-option">
              <input type="radio" name="service" value="3" />
              <span class="heart-icon">♡</span>
              <span class="heart-label">Gut</span>
            </label>
            <label class="heart-option">
              <input type="radio" name="service" value="4" />
              <span class="heart-icon">♡</span>
              <span class="heart-label">Sehr gut</span>
            </label>
            <label class="heart-option">
              <input type="radio" name="service" value="5" />
              <span class="heart-icon">♡</span>
              <span class="heart-label">Exzellent</span>
            </label>
          </div>
        </fieldset>
        <!-- Gesamt wird nicht mehr vom Benutzer eingegeben. Es wird vor dem Absenden
             aus Geschmach/Aussehen/Service berechnet, damit die Homepage eine
             konsistente Durchschnitts-Berechnung zeigen kann. -->
        <fieldset>
          <legend>
            Wie wahrscheinlich ist es, dass Sie mich weiterempfehlen?
          </legend>
          <div
            class="nps-scale"
            role="radiogroup"
            aria-label="Weiterempfehlung"
          >
            <label class="nps-item"
              ><input type="radio" name="empfehlung" value="1" required /><span
                class="nps-num"
                >1</span
              ></label
            >
            <label class="nps-item"
              ><input type="radio" name="empfehlung" value="2" /><span
                class="nps-num"
                >2</span
              ></label
            >
            <label class="nps-item"
              ><input type="radio" name="empfehlung" value="3" /><span
                class="nps-num"
                >3</span
              ></label
            >
            <label class="nps-item"
              ><input type="radio" name="empfehlung" value="4" /><span
                class="nps-num"
                >4</span
              ></label
            >
            <label class="nps-item"
              ><input type="radio" name="empfehlung" value="5" /><span
                class="nps-num"
                >5</span
              ></label
            >
            <label class="nps-item"
              ><input type="radio" name="empfehlung" value="6" /><span
                class="nps-num"
                >6</span
              ></label
            >
            <label class="nps-item"
              ><input type="radio" name="empfehlung" value="7" /><span
                class="nps-num"
                >7</span
              ></label
            >
            <label class="nps-item"
              ><input type="radio" name="empfehlung" value="8" /><span
                class="nps-num"
                >8</span
              ></label
            >
            <label class="nps-item"
              ><input type="radio" name="empfehlung" value="9" /><span
                class="nps-num"
                >9</span
              ></label
            >
            <label class="nps-item"
              ><input type="radio" name="empfehlung" value="10" /><span
                class="nps-num"
                >10</span
              ></label
            >
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              margin-top: 6px;
            "
          >
            <span class="nps-hint">eher nicht</span>
            <span class="nps-hint">auf jeden Fall</span>
          </div>
        </fieldset>
        <fieldset class="notes-fieldset">
          <legend>
            Haben Sie Anmerkungen, Wünsche oder Verbesserungsvorschläge?
          </legend>
          <textarea
            name="text"
            rows="7"
            class="lined-textarea"
            placeholder=""
          ></textarea>
        </fieldset>
        <input type="submit" value="Absenden" />
        <div id="reviewSuccess" class="alert success">
          Vielen Dank für Ihre Bewertung! Sie werden in Kürze zur Startseite
          weitergeleitet...
        </div>
        <div id="reviewError" class="alert error">
          Fehler beim Absenden. Bitte versuchen Sie es erneut.
        </div>
      </form>

      <!-- Modal für bereits bewertete Bestellungen -->
      <div
        id="alreadyReviewedModal"
        style="
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 1000;
          align-items: center;
          justify-content: center;
        "
      >
        <div
          style="
            background: #ffffff;
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            margin: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            color: #222222;
          "
        >
          <h3 style="color: #92d050; margin: 0 0 16px 0; font-size: 1.25rem;">
            Bereits bewertet
          </h3>
          <p style="margin: 0 0 24px 0; line-height: 1.5; color: #222222;">
            Sie haben bereits eine Bewertung für diese Bestellung abgegeben.
            Vielen Dank für Ihr Feedback!
          </p>
          <button
            onclick="closeModalAndRedirect()"
            style="margin: 0; background: #92d050; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-family: inherit;"
          >
            Zur Startseite
          </button>
          </button>
        </div>
      </div>

      <!-- Firebase Bibliotheken ZUERST laden -->
      <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
      <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
      <!-- EmailJS für Admin-Benachrichtigungen -->
      <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
      <!-- Dann Firebase Config und andere Configs -->
      <script src="config/firebase.js"></script>
      <script src="config/email.js"></script>
      <script src="js/common.js"></script>
      <script src="js/email-template-manager.js"></script>
      <script src="js/admin/notifications.js"></script>
      <script src="js/admin-security.js"></script>
      <script>
        // Firebase wird bereits in config/firebase.js initialisiert
        const db = initializeFirebaseApp();

        // Zugangsüberprüfung: Standardmäßig nur mit orderId+customerId erlaubt.
        // Wenn der eingeloggte Benutzer eine Admin-Session hat (adminSecurity),
        // erlauben wir das Laden der Seite auch ohne URL-Parameter.
        async function checkAccess() {
          const params = new URLSearchParams(window.location.search);
          const orderId = params.get("orderId");
          const customerId = params.get("customerId");

          // Small helper: wait briefly for adminSecurity to become available
          async function waitForAdminSecurity(timeoutMs = 500) {
            const start = Date.now();
            while (Date.now() - start < timeoutMs) {
              if (window.adminSecurity && typeof window.adminSecurity.checkSession === 'function') return true;
              await new Promise(r => setTimeout(r, 50));
            }
            return !!(window.adminSecurity && typeof window.adminSecurity.checkSession === 'function');
          }

          // If adminSecurity is available and session is valid, grant access
          try {
            const hasAdminModule = await waitForAdminSecurity(500);
            console.debug('checkAccess: admin module present?', !!hasAdminModule);
            if (hasAdminModule) {
              try {
                const adminCheck = !!window.adminSecurity.checkSession();
                console.debug('checkAccess: window.adminSecurity.checkSession() ->', adminCheck);
                if (adminCheck) {
                  return true;
                }
              } catch (e) {
                console.debug('checkAccess: window.adminSecurity.checkSession() threw', e);
                // fall through to storage fallback
              }
            }
          } catch (e) {
            // ignore and continue to storage-based checks
          }

          // Fallback: check the admin session key in localStorage or sessionStorage directly
          try {
            const TWO_HOURS = 2 * 60 * 60 * 1000;
            const sessKeys = [localStorage.getItem('lauras_admin_session'), sessionStorage.getItem('lauras_admin_session')];
            console.debug('checkAccess: storage sessions', { local: sessKeys[0], session: sessKeys[1] });
            for (const sess of sessKeys) {
              if (!sess) continue;
              try {
                const data = JSON.parse(sess);
                if (data && data.timestamp && (Date.now() - data.timestamp) < TWO_HOURS) {
                  return true;
                }
              } catch (e) {
                // invalid JSON - ignore
              }
            }
          } catch (e) {
            // ignore storage errors
          }

          if (!orderId || !customerId) {
            // Keine gültigen Parameter - zur Startseite weiterleiten
            window.location.href = "index.html";
            return false;
          }

          // Überprüfe, ob bereits eine Bewertung für diese Bestellung existiert
          try {
            const existingReviewsQuery = await db
              .collection("reviews")
              .where("orderId", "==", orderId)
              .get();

            if (!existingReviewsQuery.empty) {
              // Bewertung bereits vorhanden - Modal anzeigen
              showAlreadyReviewedModal();
              return false;
            }
          } catch (error) {
            console.log(
              "Fehler beim Überprüfen bestehender Bewertungen:",
              error
            );
            // Bei Fehler trotzdem fortfahren (Fail-Safe)
          }

          return true;
        }

        // Sofort beim Laden prüfen
        checkAccess().then((accessGranted) => {
          if (!accessGranted) {
            // Nur das Formular verstecken, nicht den ganzen Body (Modal muss sichtbar bleiben)
            const reviewForm = document.getElementById("reviewForm");
            const reviewIntro = document.querySelector(".review-intro");
            if (reviewForm) reviewForm.style.display = "none";
            if (reviewIntro) reviewIntro.style.display = "none";
          }
        });

        // orderId aus URL holen
        function getOrderId() {
          const params = new URLSearchParams(window.location.search);
          return params.get("orderId") || "";
        }

        // customerId aus URL holen
        function getCustomerId() {
          const params = new URLSearchParams(window.location.search);
          return params.get("customerId") || "";
        }

        // Kundendaten laden (falls customerId verfügbar)
        async function getCustomerName() {
          const customerId = getCustomerId();
          if (!customerId) return "";

          try {
            const customerDoc = await db
              .collection("customers")
              .doc(customerId)
              .get();
            if (customerDoc.exists) {
              return customerDoc.data().name || "";
            }
          } catch (error) {
            console.log("Kunde nicht gefunden:", error);
          }
          return "";
        }

        // Modal-Funktionen
        function showAlreadyReviewedModal() {
          console.log("Zeige Already Reviewed Modal"); // Debug
          const modal = document.getElementById("alreadyReviewedModal");
          modal.style.display = "flex";
          document.body.style.overflow = "hidden"; // Scroll verhindern
        }

        function closeModalAndRedirect() {
          window.location.href = "index.html";
        }

        document
          .getElementById("reviewForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();
            const f = this;

            // Kundennamen laden (falls customerId verfügbar)
            const customerName = await getCustomerName();

            // Compute 'gesamt' as numeric average of geschmack/aussehen/service
            const tasteVal = parseInt(f.geschmack.value) || 0;
            const appearanceVal = parseInt(f.aussehen.value) || 0;
            const serviceVal = parseInt(f.service.value) || 0;
            const catVals = [tasteVal, appearanceVal, serviceVal].filter(n => n > 0);
            const gesamtComputed = catVals.length > 0 ? Math.round((catVals.reduce((a,b)=>a+b,0)/catVals.length)) : 0;

            const review = {
              orderId: getOrderId(),
              customerId: getCustomerId(),
              customerName: customerName,
              geschmack: tasteVal,
              aussehen: appearanceVal,
              service: serviceVal,
              // store computed overall (1-5)
              gesamt: gesamtComputed,
              empfehlung: f.empfehlung.value,
              text: f.text.value,
              created: new Date().toISOString(),
            };
            try {
              await db.collection("reviews").add(review);
              
              // Admin-Benachrichtigung für neue Bewertung senden
              try {
                if (window.emailTemplateManager && window.notificationManager) {
                  await window.notificationManager.sendReviewNotification({
                    name: customerName || 'Anonym',
                    email: review.customerEmail || '',
                    orderId: review.orderId || '',
                    geschmack: parseInt(review.geschmack) || 0,
                    aussehen: parseInt(review.aussehen) || 0,
                    service: parseInt(review.service) || 0,
                    gesamt: parseInt(review.gesamt) || 0,
                    kommentar: review.text || ''
                  });
                  console.log("Admin-Benachrichtigung für Bewertung gesendet");
                }
              } catch (notificationError) {
                console.warn("Fehler beim Senden der Admin-Benachrichtigung:", notificationError);
                // Bewertung wurde trotzdem gespeichert, daher weiter fortfahren
              }
              
              // Direkt zur Startseite weiterleiten ohne Success-Nachricht
              window.location.href = "index.html";
            } catch (error) {
              console.error("Fehler beim Speichern der Bewertung:", error);
              document.getElementById("reviewError").style.display = "block";
              document.getElementById("reviewSuccess").style.display = "none";
            }
          });
      </script>

      <footer class="site-footer">
        <p>&copy; 2025 Laura's Backstube | <a href="impressum.html">Impressum</a> | <a href="datenschutz.html">Datenschutz</a></p>
      </footer>
    </div>
  </body>
</html>
